<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/controls.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: #000;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .shaka-video-container {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }
        video {
            width: 100%;
            height: 100%;
            background: #000;
            object-fit: contain;
        }

        /* YouTube Theme CSS (same as original) */
        @font-face { font-family: 'Roboto'; font-style: normal; font-weight: 400; font-display: swap; src: url(https://fonts.gstatic.com/s/roboto/v27/KFOmCnqEu92Fr1Me5Q.ttf) format('truetype'); }
        @font-face { font-family: 'Roboto'; font-style: normal; font-weight: 500; font-display: swap; src: url(https://fonts.gstatic.com/s/roboto/v27/KFOlCnqEu92Fr1MmEU9vAw.ttf) format('truetype'); }
        .youtube-theme { font-family: 'Roboto', sans-serif; }
        /* (Omitted rest of YouTube theme CSS for brevity – use your existing CSS here) */

        /* Manual play button */
        .manual-play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            z-index: 2000;
            border: 2px solid #ff0000;
            display: none;
            transition: all 0.3s ease;
        }
        .manual-play-button:hover {
            background: rgba(255, 0, 0, 0.8);
            transform: translate(-50%, -50%) scale(1.05);
        }

        /* Watermark logo - fixed for fullscreen */
        #myLogo {
            width: 40px;
            height: 40px;
            position: fixed; /* absolute → fixed */
            right: 30px;
            top: 50px;
            z-index: 9999; /* above video & controls */
            pointer-events: none; /* clicks pass through */
        }

        /* Optional: responsive adjustment */
        @media screen and (max-width: 1920px) {
            #myLogo {
                width: 50px;
                height: 50px;
                top: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>

<div class="shaka-video-container youtube-theme" data-shaka-player>
    <video autoplay muted playsinline preload="auto" poster=""></video>
    <img id="myLogo" src="https://imagefa.st/images/2025/10/18/1000098314.png">
    <div class="manual-play-button" id="manualPlayButton">▶ Click to Play</div>
</div>

<script>
    const queryParams = new URLSearchParams(window.location.search);
    const name = queryParams.get('url');
    const keyId = queryParams.get('keyId');
    const key = queryParams.get('key');

    document.addEventListener('DOMContentLoaded', async () => {
        shaka.polyfill.installAll();

        if (!shaka.Player.isBrowserSupported()) {
            console.error('Browser not supported');
            return;
        }

        const video = document.querySelector('video');
        const player = new shaka.Player();
        await player.attach(video);

        const container = document.querySelector('.shaka-video-container');
        const ui = new shaka.ui.Overlay(player, container, video);

        const config = {
            controlPanelElements: [
                'play_pause',
                'time_and_duration',
                'mute',
                'volume',
                'spacer',
                'captions',
                'quality',
                'language',
                'picture_in_picture',
                'fullscreen',
                'overflow_menu'
            ]
        };
        ui.configure(config);

        let drmConfig = {
            clearKeys: { [keyId]: key }
        };

        let streamUrl = name;
        let cookieHeader = "";

        try {
            const response = await fetch('https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u');
            const m3uText = await response.text();
            const lines = m3uText.split('\n');

            const cookieLine = lines.find(line => line.startsWith('#EXTHTTP:'));
            const cookieMatch = cookieLine?.match(/"cookie":"([^"]+)"/);
            if (cookieMatch) cookieHeader = cookieMatch[1];
        } catch (error) {
            console.error('Failed to fetch M3U:', error);
        }

        player.configure({
            drm: drmConfig,
            streaming: {
                lowLatencyMode: true,
                bufferingGoal: 15,
                rebufferingGoal: 2,
                bufferBehind: 15,
                retryParameters: { timeout: 10000, maxAttempts: 5, baseDelay: 300, backoffFactor: 1.2 },
                segmentRequestTimeout: 8000,
                segmentPrefetchLimit: 2,
                useNativeHlsOnSafari: true
            },
            manifest: { retryParameters: { timeout: 8000, maxAttempts: 3 } }
        });

        player.getNetworkingEngine().registerRequestFilter((type, request) => {
            request.headers['Referer'] = 'https://www.jiotv.com/';
            request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
            request.headers['Cookie'] = cookieHeader;
            if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
                 type === shaka.net.NetworkingEngine.RequestType.SEGMENT) &&
                !request.uris[0].includes('__hdnea__=')) {
                const separator = request.uris[0].includes('?') ? '&' : '?';
                request.uris[0] += separator + cookieHeader;
            }
        });

        const enableAutoplay = () => {
            video.setAttribute('autoplay', '');
            video.setAttribute('playsinline', '');
            video.autoplay = true;
        };

        const attemptAutoplay = async () => {
            try { video.muted = false; await video.play(); return true; }
            catch { try { video.muted = true; await video.play(); return true; } catch { return false; } }
        };

        player.addEventListener('error', (event) => console.error('Shaka Player Error:', event.detail));

        video.addEventListener('play', () => {
            if (window.self === window.top && !document.fullscreenElement && window.innerWidth <= 768) {
                container.requestFullscreen().catch(() => console.log('Fullscreen request failed'));
            }
        }, { once: true });

        video.addEventListener('loadedmetadata', () => { video.volume = 0.8; });

        let hasUserInteracted = false;
        const enableSoundOnInteraction = () => { if (!hasUserInteracted && video.muted) { video.muted = false; hasUserInteracted = true; } };
        ['click','touchstart','keydown'].forEach(event => document.addEventListener(event, enableSoundOnInteraction, { once: true }));

        try {
            enableAutoplay();
            await player.load(streamUrl);
            if (video.readyState >= 3) await attemptAutoplay();
            else { video.addEventListener('canplay', attemptAutoplay, { once: true });
                   setTimeout(async () => { if (video.paused) await attemptAutoplay(); }, 2000); }
        } catch (error) { console.error('Load error:', error); }

        document.addEventListener('visibilitychange', () => { if (!document.hidden && video.paused) attemptAutoplay(); });
    });
</script>

</body>
</html>
