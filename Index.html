<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SHAKA PLAYER - M3U8</title>
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/controls.min.css">
  <style type="text/css">
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .video-container {
      position: absolute;
      width: 100%;
      height: 100%;
      background-color: #000;
      overflow: hidden;
    }

    .shaka-video-container {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    video {
      width: 100%;
      height: 100%;
      background-color: #000;
    }

    /* YouTube Theme Improvements */
    .youtube-theme {
      font-family: 'Roboto', Arial, sans-serif;
    }

    .youtube-theme .shaka-bottom-controls {
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
    }

    .manual-play-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 16px;
      z-index: 2000;
      border: none;
      display: none;
      transition: all 0.3s ease;
    }

    .manual-play-button:hover {
      background: rgba(255, 0, 0, 0.8);
      transform: translate(-50%, -50%) scale(1.05);
    }

    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 16px;
      z-index: 1999;
      display: none;
    }
  </style>
</head>
<body>
  <div class="video-container">
    <div class="shaka-video-container youtube-theme" data-shaka-player>
      <video id="video" autoplay muted playsinline preload="auto"></video>
    </div>
    
    <div class="manual-play-button" id="manualPlayButton">
      â–¶ Play Stream
    </div>
    
    <div class="loading-indicator" id="loadingIndicator">
      Loading Stream...
    </div>
  </div>

  <script>
    const queryParams = new URLSearchParams(window.location.search);
    const url = queryParams.get('url');
    
    // Default test stream if no URL provided
    const defaultStream = 'https://dai.google.com/linear/hls/event/5zxrjANPRmCr_IiIHjgaww/master.m3u8';
    
    const channelstreamInfo = {    
      streamUrl: url || defaultStream,   
      authBearer: "",     
      streamPoster: "",  
    };

    let player;
    const video = document.getElementById('video');

    async function initializePlayer() {
      try {
        // Show loading indicator
        document.getElementById('loadingIndicator').style.display = 'block';

        // Initialize Shaka Player
        shaka.polyfill.installAll();
        
        if (!shaka.Player.isBrowserSupported()) {
          throw new Error('Browser not supported by Shaka Player');
        }

        player = new shaka.Player(video);
        
        const container = document.querySelector('.shaka-video-container');
        const ui = new shaka.ui.Overlay(player, container, video);
        
        // UI Configuration
        const config = {
          'seekBarColors': {
            base: 'rgba(255,255,255,.2)',
            buffered: 'rgba(255,255,255,.4)', 
            played: 'rgb(255,0,0)',
          },
          'controlPanelElements': [
            'play_pause',
            'mute',
            'time_and_duration',
            'spacer',
            'quality',
            'picture_in_picture',
            'fullscreen',
            'overflow_menu'
          ]
        };
        
        ui.configure(config);

        // Player configuration for M3U8 streams
        player.configure({
          streaming: {
            lowLatencyMode: true,
            bufferingGoal: 15,
            rebufferingGoal: 2,
            bufferBehind: 20,
            retryParameters: {
              timeout: 10000,
              maxAttempts: 3,
              baseDelay: 1000,
              backoffFactor: 2
            }
          },
          manifest: {
            retryParameters: {
              timeout: 8000,
              maxAttempts: 2
            }
          }
        });

        // Add request filters for CORS
        player.getNetworkingEngine().registerRequestFilter((type, request) => {
          request.headers['User-Agent'] = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36';
          request.headers['Origin'] = window.location.origin;
          request.headers['Referer'] = window.location.origin;
        });

        console.log('Loading stream:', channelstreamInfo.streamUrl);
        
        // Load the stream
        await player.load(channelstreamInfo.streamUrl);
        
        console.log('Stream loaded successfully');
        document.getElementById('loadingIndicator').style.display = 'none';

        // Attempt autoplay
        await attemptAutoplay();

      } catch (error) {
        console.error('Error initializing player:', error);
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('manualPlayButton').style.display = 'block';
        
        // Fallback to native video element
        try {
          video.src = channelstreamInfo.streamUrl;
          video.autoplay = true;
          video.muted = true;
          await video.play();
        } catch (fallbackError) {
          console.error('Fallback also failed:', fallbackError);
        }
      }
    }

    async function attemptAutoplay() {
      try {
        video.muted = false;
        await video.play();
        console.log('Autoplay successful with sound');
        return true;
      } catch (error) {
        console.log('Unmuted autoplay failed, trying muted:', error.message);
        try {
          video.muted = true;
          await video.play();
          console.log('Autoplay successful with muted audio');
          
          // Show unmute button or enable sound on interaction
          enableSoundOnInteraction();
          return true;
        } catch (mutedError) {
          console.log('Muted autoplay also failed:', mutedError.message);
          document.getElementById('manualPlayButton').style.display = 'block';
          return false;
        }
      }
    }

    function enableSoundOnInteraction() {
      const enableSound = () => {
        if (video.muted) {
          video.muted = false;
          console.log('Sound enabled after user interaction');
        }
      };
      
      ['click', 'touchstart', 'keydown'].forEach(event => {
        document.addEventListener(event, enableSound, { once: true });
      });
    }

    // Manual play button handler
    document.getElementById('manualPlayButton').addEventListener('click', async () => {
      document.getElementById('manualPlayButton').style.display = 'none';
      await attemptAutoplay();
    });

    // Error handling
    player.addEventListener('error', (event) => {
      console.error('Player error:', event.detail);
      document.getElementById('manualPlayButton').style.display = 'block';
    });

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initializePlayer().catch(error => {
        console.error('Initialization failed:', error);
      });
    });

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && video.paused) {
        video.play().catch(console.error);
      }
    });
  </script>
</body>
</html>
